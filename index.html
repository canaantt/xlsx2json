<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.0-rc.2/jquery-ui.min.js" integrity="sha256-55Jz3pBCF8z9jBO1qQ7cIf0L+neuPTD1u7Ytzrp2dqo=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.11.19/shim.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.11.19/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
        <script type="text/javascript" src="DatasetValidate.js"></script>
        <script type="text/javascript" src="DatasetHelping.js"></script>
        <script type="text/javascript" src="DatasetLoad.js"></script>
        <script type="text/javascript" src="DatasetSerialize.js"></script>
        <script type="text/javascript" src="DatasetSave.js"></script>
        <title>
            Test parsing excel in browser.
        </title>
    </head>
    <body>
        <h1>Test parsing excel in browser.</h1>
        <input type='file' id='input_dom_element'></input>
        <script>
            var rABS = true; // true: readAsBinaryString ; false: readAsArrayBuffer
            var workbook;
            var genemap;
            var requirements;
            var data;
            var sheets; 
            var sheetsSerialized = [];
            var projectID = 'hardCodedProjectID';
            var db = new Dexie("userData");
            $.getJSON("DatasetGenemap.json", function(result){
                genemap = result;
            });
            $.getJSON("DatasetRequirements.json", function(result){
                requirements = result;
            });
            function handleFile(e) {
                var files = e.target.files, f = files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    data = e.target.result;
                    if(!rABS) data = new Uint8Array(data);
                    workbook = XLSX.read(data, {sheetStubs: true, type: rABS ? 'binary' : 'array'});
                    sheets = workbook.SheetNames.map( name => ({ name: name, data: workbook.Sheets[name] }));
                    var errors = {};
                    errors['sheet_level'] = sheets.map(sheet => Validator.validateSheet(sheet, requirements, _, datasetHelper));
    
                    // Validate Workbook (Generic)
                    errors['sheets_existence'] = Validator.validateWorkbookExistence(sheets, requirements, genemap, _, datasetHelper);
                    errors['patientID_overlapping'] = Validator.validateWorkbookPatientIDOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    errors['sampleID_overlapping'] = Validator.validateWorkbookSampleIDOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    errors['geneID_overlapping'] = Validator.validateWorkbookGeneIDsOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    
                    sheets.forEach(sheet => {
                        sheetsSerialized = sheetsSerialized.concat(Serializer.sheet(sheet, _, XLSX));
                    }); 
                    uploadResults = sheetsSerialized.map(sheet => Save.local(sheet, projectID));
    
                    // Serialize Manifest (Generic)
                    manifestSerialized = Serializer.manifest(sheetsSerialized, uploadResults);
                    console.log(manifestSerialized);
                    // Define a schema
                    db.version(1).stores(manifestSerialized.schema);
                    // Open the database
                    db.dataset.put({name: projectID});
                    
                    // db.friends.put({name: "Nicolas", shoeSize: 8}).then (function(){
                    //     //
                    //     // Then when data is stored, read from it
                    //     //
                    //     return db.friends.get('Nicolas');
                    // }).then(function (friend) {
                    //     //
                    //     // Display the result
                    //     //
                    //     alert ("Nicolas has shoe size " + friend.shoeSize);
                    // }).catch(function(error) {
                    //     //
                    //     // Finally don't forget to catch any error
                    //     // that could have happened anywhere in the
                    //     // code blocks above.
                    //     //
                    //     alert ("Ooops: " + error);
                    // });

                    
                    // xlsx2json(workbook);
                    /* DO SOMETHING WITH workbook HERE */
                };
                if(rABS) reader.readAsBinaryString(f); else reader.readAsArrayBuffer(f);
            }
            input_dom_element.addEventListener('change', handleFile, false);

        </script>
    </body>
</html>