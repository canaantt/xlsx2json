<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.0-rc.2/jquery-ui.min.js" integrity="sha256-55Jz3pBCF8z9jBO1qQ7cIf0L+neuPTD1u7Ytzrp2dqo=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.11.19/shim.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.11.19/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
        <script type="text/javascript" src="/Uploading_Modules/DatasetValidate.js"></script>
        <script type="text/javascript" src="/Uploading_Modules/DatasetHelping.js"></script>
        <script type="text/javascript" src="/Uploading_Modules/DatasetLoad.js"></script>
        <script type="text/javascript" src="/Uploading_Modules/DatasetSerialize.js"></script>
        <script type="text/javascript" src="/Uploading_Modules/DatasetSave.js"></script>
        <title>
            Test parsing excel in browser.
        </title>
    </head>
    <body>
        <h1>Test parsing excel in browser.</h1>
        <input type='file' id='input_dom_element'></input>
        <script>
            var rABS = true; // true: readAsBinaryString ; false: readAsArrayBuffer
            var workbook;
            var genemap;
            var requirements;
            var data;
            var sheets; 
            var sheetsSerialized = [];
            var manifestSerialized; 
            var projectID = 'hardCodedProjectID';
            var db = new Dexie("userData");
            $.getJSON("/Uploading_Modules/DatasetGenemap.json", function(result){
                genemap = result;
            });
            $.getJSON("/Uploading_Modules/DatasetRequirements.json", function(result){
                requirements = result;
            });
            function handleFile(e) {
                var files = e.target.files, f = files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    data = e.target.result;
                    if(!rABS) data = new Uint8Array(data);
                    workbook = XLSX.read(data, {sheetStubs: true, type: rABS ? 'binary' : 'array'});
                    sheets = workbook.SheetNames.map( name => ({ name: name, data: workbook.Sheets[name] }));
                    var errors = {};
                    errors['sheet_level'] = sheets.map(sheet => Validator.validateSheet(sheet, requirements, _, datasetHelper));

                    // Validate Workbook (Generic)
                    errors['sheets_existence'] = Validator.validateWorkbookExistence(sheets, requirements, genemap, _, datasetHelper);
                    errors['patientID_overlapping'] = Validator.validateWorkbookPatientIDOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    errors['sampleID_overlapping'] = Validator.validateWorkbookSampleIDOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    errors['geneID_overlapping'] = Validator.validateWorkbookGeneIDsOverlapping(sheets, requirements, genemap, _, datasetHelper);
                    
                    sheets.forEach(sheet => {
                        sheetsSerialized = sheetsSerialized.concat(Serializer.sheet(sheet, _, XLSX));
                    }); 
                    uploadResults = sheetsSerialized.map(sheet => Save.local(sheet, projectID));

                    // Serialize Manifest (Generic)
                    manifestSerialized = Serializer.manifest(sheetsSerialized, uploadResults);
                    console.log(manifestSerialized);
                    // Define a schema
                    db.version(1).stores(manifestSerialized.schema);
                    // Open the database
                    db.dataset.put({name: projectID});
                    sheets.forEach(sheet => {
                        var type = sheet.name.split('-')[0];
                        var data = XLSX.utils.sheet_to_json(sheet.data, {header:1, raw:true, blankrows: false});
                        switch (type){
                            case 'PATIENT':
                                data.splice(0, 1);
                                data.forEach(d => {
                                    var obj = {};
                                    manifestSerialized.schema.patient.split(',').forEach((k, i) => {
                                        obj[k] = d[i]
                                    });
                                    db.patient.put(obj);
                                });
                                // db.patientMeta.put();
                                break;
                            case 'SAMPLE':
                                var header = data[0];
                                data.splice(0, 1);
                                var pt_ind = header.map(h => h.toUpperCase()).indexOf('PATIENTID');
                                data.forEach(d => d.splice(pt_ind, 1));
                                data.forEach(d => {
                                    var obj = {};
                                    manifestSerialized.schema.sample.split(',').forEach((k, i) => {
                                        obj[k] = d[i]
                                    });
                                    db.sample.put(obj);
                                });
                                // db.sampleMeta.put();
                                break;
                            case 'EVENT':
                                var header = data[0];
                                var pt_ind = header.map(h => h.toUpperCase()).indexOf('PATIENTID');
                                var start_ind = header.map(h => h.toUpperCase()).indexOf('STARTDATE');
                                var end_ind = header.map(h => h.toUpperCase()).indexOf('ENDDATE');
                                var subtype_ind = header.map(h => h.toUpperCase()).indexOf('TYPE');
                                var type_ind = header.map(h => h.toUpperCase()).indexOf('CATEGORY');
                                var data_header = header.filter(h => [header[pt_ind], header[start_ind], header[end_ind], 
                                                  header[subtype_ind], header[type_ind]].indexOf(h) == -1);
                                var data_indices = data_header.map(h => header.indexOf(h));
                                data.splice(0, 1);
                                data.forEach(d => {
                                    var obj = {};
                                    obj.p = d[pt_ind];
                                    obj.start = d[start_ind];
                                    obj.end = d[end_ind];
                                    obj.subtype = d[subtype_ind];
                                    obj.type = d[type_ind];
                                    var o = {};
                                    data_indices.forEach((ind) => o[header[ind]] = d[ind] );
                                    obj.data = o;
                                    db.events.put(obj);
                                });
                                break;
                            case 'SAMPLE':
                                var header = data[0];
                                data.splice(0, 1);
                                var pt_ind = header.map(h=>h.toUpperCase()).indexOf('PATIENTID');
                                var sp_ind = header.map(h=>h.toUpperCase()).indexOf('SAMPLEID');
                                data.forEach(d => {
                                    var obj = {};
                                    obj.p = d[pt_ind];
                                    obj.s = d[sp_ind];
                                    db.patientSampleMap.put(obj);
                                });
                                // db.sample.put();
                                break;
                            case 'MATRIX':
                                data.splice(0, 2);
                                data[0].shift(1);
                                var samples = data[0];
                                var collectionName = sheet.name.split('-')[2];
                                var mapCollectionName = collectionName + 'Map';
                                samples.forEach((s,i) => {
                                    var obj = {};
                                    obj.s = s;
                                    obj.i = i;
                                    db[mapCollectionName].put(obj);
                                });
                                data.splice(0, 1);
                                data.forEach((d,i) => {
                                    var obj = {};
                                    obj.m = d[0];
                                    d.shift(1);
                                    obj.d = d;
                                    obj.max = d.reduce((a, b) => Math.max(a, b));
                                    obj.min = d.reduce((a, b) => Math.min(a, b));
                                    obj.mean = d.reduce((a, b) => a = a+b)/d.length;
                                    db[collectionName].put(obj);
                                });
                                break;
                            case 'MUT':
                                break;
                            case 'GENESETS':
                                data.forEach(d => {
                                    var obj = {};
                                    obj.n = d[0];
                                    d.shift(1);
                                    obj.data = d;
                                    db.geneset.put(obj);
                                });
                                break;

                        }
                            
                    });                
                };
                if(rABS) reader.readAsBinaryString(f); else reader.readAsArrayBuffer(f);
            }
            input_dom_element.addEventListener('change', handleFile, false);
        </script>
    </body>
</html>